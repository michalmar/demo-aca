{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "languageVersion": "2.0",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.35.1.17967",
      "templateHash": "8059517107941446075"
    }
  },
  "parameters": {
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Primary deployment location for all resources."
      }
    },
    "resourceTags": {
      "type": "object",
      "defaultValue": {},
      "metadata": {
        "description": "Tags applied to all resources created by this template."
      }
    },
    "containerAppsEnvironmentName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Azure Container Apps environment that hosts the frontend and backend apps."
      }
    },
    "logAnalyticsWorkspaceName": {
      "type": "string",
      "metadata": {
        "description": "Log Analytics workspace name used for Azure Container Apps diagnostics."
      }
    },
    "logAnalyticsRetentionDays": {
      "type": "int",
      "defaultValue": 30,
      "metadata": {
        "description": "Number of days to retain logs in Log Analytics."
      }
    },
    "acrName": {
      "type": "string",
      "metadata": {
        "description": "Name of the Azure Container Registry (must be globally unique)."
      }
    },
    "acrSku": {
      "type": "string",
      "defaultValue": "Basic",
      "metadata": {
        "description": "SKU of the Azure Container Registry."
      }
    },
    "adminUserEnabled": {
      "type": "bool",
      "defaultValue": true,
      "metadata": {
        "description": "Enable admin user for simplified authentication (dev/test only)."
      }
    },
    "cosmosAccountName": {
      "type": "string",
      "metadata": {
        "description": "Cosmos DB account name (must be globally unique)."
      }
    },
    "cosmosDatabaseName": {
      "type": "string",
      "defaultValue": "appdb",
      "metadata": {
        "description": "Name of the Cosmos DB SQL database."
      }
    },
    "cosmosContainerName": {
      "type": "string",
      "defaultValue": "questionnaire",
      "metadata": {
        "description": "Name of the Cosmos DB SQL container."
      }
    },
    "cosmosContainerPartitionKey": {
      "type": "string",
      "defaultValue": "/partitionKey",
      "metadata": {
        "description": "Partition key path for the Cosmos DB SQL container."
      }
    },
    "backendAppName": {
      "type": "string",
      "defaultValue": "backend-api",
      "metadata": {
        "description": "Name of the backend Azure Container App."
      }
    },
    "backendContainerImage": {
      "type": "string",
      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
      "metadata": {
        "description": "Container image for the backend Azure Container App."
      }
    },
    "backendTargetPort": {
      "type": "int",
      "defaultValue": 8080,
      "metadata": {
        "description": "Target port exposed by the backend container."
      }
    },
    "backendMinReplicas": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Minimum number of backend replicas."
      }
    },
    "backendMaxReplicas": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Maximum number of backend replicas."
      }
    },
    "backendCpu": {
      "type": "string",
      "defaultValue": "0.5",
      "metadata": {
        "description": "CPU cores allocated to the backend container (e.g. \"0.5\")."
      }
    },
    "backendMemory": {
      "type": "string",
      "defaultValue": "1Gi",
      "metadata": {
        "description": "Memory allocated to the backend container (e.g. \"1Gi\")."
      }
    },
    "backendEnvironmentVariables": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "Optional backend environment variables."
      }
    },
    "backendIdentityName": {
      "type": "string",
      "defaultValue": "[format('{0}-id', parameters('backendAppName'))]",
      "metadata": {
        "description": "Name of the backend user-assigned managed identity."
      }
    },
    "frontendAppName": {
      "type": "string",
      "defaultValue": "frontend-web",
      "metadata": {
        "description": "Name of the frontend Azure Container App."
      }
    },
    "frontendContainerImage": {
      "type": "string",
      "defaultValue": "mcr.microsoft.com/azuredocs/containerapps-helloworld:latest",
      "metadata": {
        "description": "Container image for the frontend Azure Container App."
      }
    },
    "frontendTargetPort": {
      "type": "int",
      "defaultValue": 3000,
      "metadata": {
        "description": "Target port exposed by the frontend container."
      }
    },
    "frontendMinReplicas": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Minimum number of frontend replicas."
      }
    },
    "frontendMaxReplicas": {
      "type": "int",
      "defaultValue": 2,
      "metadata": {
        "description": "Maximum number of frontend replicas."
      }
    },
    "frontendCpu": {
      "type": "string",
      "defaultValue": "0.5",
      "metadata": {
        "description": "CPU cores allocated to the frontend container (e.g. \"0.5\")."
      }
    },
    "frontendMemory": {
      "type": "string",
      "defaultValue": "1Gi",
      "metadata": {
        "description": "Memory allocated to the frontend container (e.g. \"1Gi\")."
      }
    },
    "frontendIdentityName": {
      "type": "string",
      "defaultValue": "[format('{0}-id', parameters('frontendAppName'))]",
      "metadata": {
        "description": "Name of the frontend user-assigned managed identity."
      }
    },
    "githubIdentityName": {
      "type": "string",
      "defaultValue": "github-federation-mi",
      "metadata": {
        "description": "Name of the GitHub federation managed identity."
      }
    },
    "githubFederatedSubjects": {
      "type": "array",
      "defaultValue": [],
      "metadata": {
        "description": "GitHub OIDC subjects granted access (e.g. repo:org/repo:ref)."
      }
    },
    "principalId": {
      "type": "string",
      "metadata": {
        "description": "Id of the user or app to assign application roles"
      }
    }
  },
  "resources": {
    "containerRegistryExisting": {
      "existing": true,
      "type": "Microsoft.ContainerRegistry/registries",
      "apiVersion": "2023-07-01",
      "name": "[parameters('acrName')]"
    },
    "backendIdentityExisting": {
      "existing": true,
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[parameters('backendIdentityName')]"
    },
    "frontendIdentityExisting": {
      "existing": true,
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[parameters('frontendIdentityName')]"
    },
    "backendAcrPull": {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('acrName'))]",
      "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('backendIdentityName')), 'acr-pull')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
        "principalId": "[reference('backendIdentity').outputs.principalId.value]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "backendIdentity"
      ]
    },
    "frontendAcrPull": {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('acrName'))]",
      "name": "[guid(resourceId('Microsoft.ContainerRegistry/registries', parameters('acrName')), resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('frontendIdentityName')), 'acr-pull')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '7f951dda-4ed3-4680-a7ca-43fe172d538d')]",
        "principalId": "[reference('frontendIdentity').outputs.principalId.value]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "frontendIdentity"
      ]
    },
    "githubIdentityContributorRole": {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "name": "[guid(subscription().subscriptionId, resourceGroup().name, parameters('githubIdentityName'), 'rg-contributor')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'b24988ac-6180-42a0-ab88-20f7382dd24c')]",
        "principalId": "[reference('githubIdentity').outputs.principalId.value]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "githubIdentity"
      ]
    },
    "githubIdentityAcrPushRole": {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.ContainerRegistry/registries/{0}', parameters('acrName'))]",
      "name": "[guid(subscription().subscriptionId, parameters('acrName'), parameters('githubIdentityName'), 'acr-push')]",
      "properties": {
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '8311e382-0749-4cb8-b61a-304f252e45ec')]",
        "principalId": "[reference('githubIdentity').outputs.principalId.value]",
        "principalType": "ServicePrincipal"
      },
      "dependsOn": [
        "githubIdentity"
      ]
    },
    "githubIdentityExisting": {
      "existing": true,
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[parameters('githubIdentityName')]"
    },
    "githubFederatedCredentials": {
      "copy": {
        "name": "githubFederatedCredentials",
        "count": "[length(parameters('githubFederatedSubjects'))]"
      },
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities/federatedIdentityCredentials",
      "apiVersion": "2023-01-31",
      "name": "[format('{0}/{1}', parameters('githubIdentityName'), guid(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('githubIdentityName')), parameters('githubFederatedSubjects')[copyIndex()]))]",
      "properties": {
        "issuer": "https://token.actions.githubusercontent.com",
        "subject": "[parameters('githubFederatedSubjects')[copyIndex()]]",
        "audiences": [
          "api://AzureADTokenExchange"
        ]
      }
    },
    "containerAppEnvironment": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "container-app-environment",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "environmentName": {
            "value": "[parameters('containerAppsEnvironmentName')]"
          },
          "logAnalyticsWorkspaceName": {
            "value": "[parameters('logAnalyticsWorkspaceName')]"
          },
          "logAnalyticsRetentionDays": {
            "value": "[parameters('logAnalyticsRetentionDays')]"
          },
          "tags": {
            "value": "[parameters('resourceTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.35.1.17967",
              "templateHash": "12906154769274796928"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Location for the resources."
              }
            },
            "environmentName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Container Apps managed environment."
              }
            },
            "logAnalyticsWorkspaceName": {
              "type": "string",
              "metadata": {
                "description": "Name of the Log Analytics workspace that backs diagnostics."
              }
            },
            "logAnalyticsRetentionDays": {
              "type": "int",
              "defaultValue": 30,
              "metadata": {
                "description": "Days to retain logs in Log Analytics."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags applied to all resources created by this module."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.OperationalInsights/workspaces",
              "apiVersion": "2022-10-01",
              "name": "[parameters('logAnalyticsWorkspaceName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "retentionInDays": "[parameters('logAnalyticsRetentionDays')]",
                "features": {
                  "searchVersion": 2
                }
              },
              "sku": {
                "name": "PerGB2018"
              }
            },
            {
              "type": "Microsoft.App/managedEnvironments",
              "apiVersion": "2023-05-01",
              "name": "[parameters('environmentName')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "properties": {
                "appLogsConfiguration": {
                  "destination": "log-analytics",
                  "logAnalyticsConfiguration": {
                    "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2022-10-01').customerId]",
                    "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2020-08-01').primarySharedKey]"
                  }
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
              ]
            }
          ],
          "outputs": {
            "environmentId": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/managedEnvironments', parameters('environmentName'))]"
            },
            "logAnalyticsWorkspaceId": {
              "type": "string",
              "value": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName'))]"
            },
            "logAnalyticsCustomerId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2022-10-01').customerId]"
            },
            "logAnalyticsSharedKey": {
              "type": "securestring",
              "value": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', parameters('logAnalyticsWorkspaceName')), '2020-08-01').primarySharedKey]"
            }
          }
        }
      }
    },
    "containerRegistry": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "container-registry",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "name": {
            "value": "[parameters('acrName')]"
          },
          "sku": {
            "value": "[parameters('acrSku')]"
          },
          "adminUserEnabled": {
            "value": "[parameters('adminUserEnabled')]"
          },
          "tags": {
            "value": "[parameters('resourceTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.35.1.17967",
              "templateHash": "9335352395864105349"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for ACR."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Globally unique registry name."
              }
            },
            "sku": {
              "type": "string",
              "defaultValue": "Basic",
              "metadata": {
                "description": "SKU tier for the registry."
              }
            },
            "adminUserEnabled": {
              "type": "bool",
              "defaultValue": false,
              "metadata": {
                "description": "Should the admin user be enabled (dev/test only)."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the registry."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ContainerRegistry/registries",
              "apiVersion": "2023-07-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "sku": {
                "name": "[parameters('sku')]"
              },
              "properties": {
                "adminUserEnabled": "[parameters('adminUserEnabled')]",
                "publicNetworkAccess": "Enabled",
                "networkRuleBypassOptions": "AzureServices",
                "policies": {
                  "quarantinePolicy": {
                    "status": "disabled"
                  },
                  "trustPolicy": {
                    "type": "Notary",
                    "status": "disabled"
                  },
                  "retentionPolicy": {
                    "days": 7,
                    "status": "disabled"
                  }
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.ContainerRegistry/registries', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "loginServer": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ContainerRegistry/registries', parameters('name')), '2023-07-01').loginServer]"
            }
          }
        }
      }
    },
    "cosmos": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "cosmos-db",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "accountName": {
            "value": "[parameters('cosmosAccountName')]"
          },
          "databaseName": {
            "value": "[parameters('cosmosDatabaseName')]"
          },
          "containerName": {
            "value": "[parameters('cosmosContainerName')]"
          },
          "partitionKeyPath": {
            "value": "[parameters('cosmosContainerPartitionKey')]"
          },
          "userPrincipalId": {
            "value": "[parameters('principalId')]"
          },
          "backendPrincipalId": {
            "value": "[reference('backendIdentity').outputs.principalId.value]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.35.1.17967",
              "templateHash": "17719171655481584071"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Azure region for Cosmos DB resources."
              }
            },
            "accountName": {
              "type": "string",
              "metadata": {
                "description": "Cosmos DB account name (globally unique)."
              }
            },
            "databaseName": {
              "type": "string",
              "metadata": {
                "description": "SQL database name."
              }
            },
            "containerName": {
              "type": "string",
              "metadata": {
                "description": "SQL container name."
              }
            },
            "partitionKeyPath": {
              "type": "string",
              "metadata": {
                "description": "Partition key path for the SQL container."
              }
            },
            "userPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the user executing the deployment"
              }
            },
            "backendPrincipalId": {
              "type": "string",
              "metadata": {
                "description": "Principal ID of the backend Azure Container App managed identity."
              }
            },
            "defaultConsistencyLevel": {
              "type": "string",
              "defaultValue": "Session",
              "allowedValues": [
                "Eventual",
                "ConsistentPrefix",
                "Session",
                "BoundedStaleness",
                "Strong"
              ],
              "metadata": {
                "description": "The default consistency level of the Cosmos DB account"
              }
            }
          },
          "variables": {
            "dataContributorRoleId": "[format('{0}/sqlRoleDefinitions/00000000-0000-0000-0000-000000000002', resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName')))]"
          },
          "resources": [
            {
              "type": "Microsoft.DocumentDB/databaseAccounts",
              "apiVersion": "2025-04-15",
              "name": "[parameters('accountName')]",
              "location": "[parameters('location')]",
              "kind": "GlobalDocumentDB",
              "properties": {
                "databaseAccountOfferType": "Standard",
                "consistencyPolicy": {
                  "defaultConsistencyLevel": "[parameters('defaultConsistencyLevel')]"
                },
                "locations": [
                  {
                    "locationName": "[parameters('location')]",
                    "failoverPriority": 0,
                    "isZoneRedundant": false
                  }
                ],
                "capabilities": [
                  {
                    "name": "EnableServerless"
                  }
                ],
                "enableFreeTier": false,
                "enableAutomaticFailover": false,
                "enableMultipleWriteLocations": false,
                "publicNetworkAccess": "Enabled",
                "disableKeyBasedMetadataWriteAccess": false
              }
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}', parameters('accountName'), parameters('databaseName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('databaseName')]"
                }
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlDatabases/containers",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}/{2}', parameters('accountName'), parameters('databaseName'), parameters('containerName'))]",
              "properties": {
                "resource": {
                  "id": "[parameters('containerName')]",
                  "partitionKey": {
                    "kind": "Hash",
                    "paths": [
                      "[parameters('partitionKeyPath')]"
                    ]
                  },
                  "indexingPolicy": {
                    "indexingMode": "consistent",
                    "automatic": true,
                    "includedPaths": [
                      {
                        "path": "/*"
                      }
                    ],
                    "excludedPaths": [
                      {
                        "path": "/\"_etag\"/?"
                      }
                    ]
                  }
                },
                "options": {}
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts/sqlDatabases', parameters('accountName'), parameters('databaseName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}', parameters('accountName'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName')), parameters('userPrincipalId'), 'cosmos-data-contributor-user'))]",
              "properties": {
                "roleDefinitionId": "[variables('dataContributorRoleId')]",
                "principalId": "[parameters('userPrincipalId')]",
                "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName'))]"
              ]
            },
            {
              "type": "Microsoft.DocumentDB/databaseAccounts/sqlRoleAssignments",
              "apiVersion": "2023-04-15",
              "name": "[format('{0}/{1}', parameters('accountName'), guid(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName')), parameters('backendPrincipalId'), 'cosmos-data-contributor-backend'))]",
              "properties": {
                "roleDefinitionId": "[variables('dataContributorRoleId')]",
                "principalId": "[parameters('backendPrincipalId')]",
                "scope": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName'))]"
              },
              "dependsOn": [
                "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName'))]"
              ]
            }
          ],
          "outputs": {
            "accountId": {
              "type": "string",
              "value": "[resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName'))]"
            },
            "accountName": {
              "type": "string",
              "value": "[parameters('accountName')]"
            },
            "endpoint": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName')), '2025-04-15').documentEndpoint]"
            },
            "primaryKey": {
              "type": "securestring",
              "value": "[listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName')), '2021-04-15').primaryMasterKey]"
            },
            "connectionString": {
              "type": "securestring",
              "value": "[format('AccountEndpoint={0};AccountKey={1};', reference(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName')), '2025-04-15').documentEndpoint, listKeys(resourceId('Microsoft.DocumentDB/databaseAccounts', parameters('accountName')), '2021-04-15').primaryMasterKey)]"
            },
            "dataContributorRoleId": {
              "type": "string",
              "value": "[variables('dataContributorRoleId')]"
            },
            "databaseName": {
              "type": "string",
              "value": "[parameters('databaseName')]"
            },
            "containerName": {
              "type": "string",
              "value": "[parameters('containerName')]"
            }
          }
        }
      },
      "dependsOn": [
        "backendIdentity"
      ]
    },
    "backendIdentity": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "backend-identity",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('backendIdentityName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('resourceTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.35.1.17967",
              "templateHash": "11973657107100404554"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the user-assigned managed identity."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags applied to the identity."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name'))]"
            },
            "clientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').clientId]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').principalId]"
            }
          }
        }
      }
    },
    "frontendIdentity": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "frontend-identity",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('frontendIdentityName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('resourceTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.35.1.17967",
              "templateHash": "11973657107100404554"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the user-assigned managed identity."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags applied to the identity."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name'))]"
            },
            "clientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').clientId]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').principalId]"
            }
          }
        }
      }
    },
    "githubIdentity": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "github-identity",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "name": {
            "value": "[parameters('githubIdentityName')]"
          },
          "location": {
            "value": "[parameters('location')]"
          },
          "tags": {
            "value": "[parameters('resourceTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.35.1.17967",
              "templateHash": "11973657107100404554"
            }
          },
          "parameters": {
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the user-assigned managed identity."
              }
            },
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Optional tags applied to the identity."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
              "apiVersion": "2023-01-31",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]"
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name'))]"
            },
            "clientId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').clientId]"
            },
            "principalId": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', parameters('name')), '2023-01-31').principalId]"
            }
          }
        }
      }
    },
    "backendApp": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "backend-app",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "name": {
            "value": "[parameters('backendAppName')]"
          },
          "managedEnvironmentId": {
            "value": "[listOutputsWithSecureValues(resourceId('Microsoft.Resources/deployments', 'container-app-environment'), '2022-09-01').environmentId]"
          },
          "image": {
            "value": "[parameters('backendContainerImage')]"
          },
          "targetPort": {
            "value": "[parameters('backendTargetPort')]"
          },
          "minReplicas": {
            "value": "[parameters('backendMinReplicas')]"
          },
          "maxReplicas": {
            "value": "[parameters('backendMaxReplicas')]"
          },
          "cpu": {
            "value": "[parameters('backendCpu')]"
          },
          "memory": {
            "value": "[parameters('backendMemory')]"
          },
          "environmentVariables": {
            "value": "[parameters('backendEnvironmentVariables')]"
          },
          "identityId": {
            "value": "[reference('backendIdentity').outputs.id.value]"
          },
          "identityClientId": {
            "value": "[reference('backendIdentity').outputs.clientId.value]"
          },
          "cosmosEndpoint": {
            "value": "[listOutputsWithSecureValues(resourceId('Microsoft.Resources/deployments', 'cosmos-db'), '2022-09-01').endpoint]"
          },
          "cosmosDatabaseName": {
            "value": "[parameters('cosmosDatabaseName')]"
          },
          "cosmosContainerName": {
            "value": "[parameters('cosmosContainerName')]"
          },
          "acrLoginServer": {
            "value": "[reference('containerRegistry').outputs.loginServer.value]"
          },
          "tags": {
            "value": "[parameters('resourceTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.35.1.17967",
              "templateHash": "1526116187243139416"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location for the backend container app."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the container app."
              }
            },
            "managedEnvironmentId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Container Apps managed environment."
              }
            },
            "image": {
              "type": "string",
              "metadata": {
                "description": "Container image to deploy."
              }
            },
            "targetPort": {
              "type": "int",
              "metadata": {
                "description": "Target port exposed by the container."
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Minimum number of replicas."
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 2,
              "metadata": {
                "description": "Maximum number of replicas."
              }
            },
            "cpu": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "CPU allocation for the container (e.g. \"0.5\")."
              }
            },
            "memory": {
              "type": "string",
              "defaultValue": "1Gi",
              "metadata": {
                "description": "Memory allocation for the container (e.g. \"1Gi\")."
              }
            },
            "environmentVariables": {
              "type": "array",
              "defaultValue": [],
              "metadata": {
                "description": "Extra environment variables to merge into the container spec."
              }
            },
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned identity resource ID."
              }
            },
            "identityClientId": {
              "type": "string",
              "metadata": {
                "description": "Client ID of the user-assigned identity."
              }
            },
            "cosmosEndpoint": {
              "type": "string",
              "metadata": {
                "description": "Cosmos DB endpoint exposed to the app."
              }
            },
            "cosmosDatabaseName": {
              "type": "string",
              "metadata": {
                "description": "Cosmos DB database name."
              }
            },
            "cosmosContainerName": {
              "type": "string",
              "metadata": {
                "description": "Cosmos DB container name."
              }
            },
            "acrLoginServer": {
              "type": "string",
              "metadata": {
                "description": "Login server of the Azure Container Registry used for the image."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the container app."
              }
            }
          },
          "variables": {
            "mergedEnv": "[concat(parameters('environmentVariables'), createArray(createObject('name', 'AZURE_CLIENT_ID', 'value', parameters('identityClientId')), createObject('name', 'COSMOS_ENDPOINT', 'value', parameters('cosmosEndpoint')), createObject('name', 'COSMOS_DATABASE_NAME', 'value', parameters('cosmosDatabaseName')), createObject('name', 'COSMOS_CONTAINER_NAME', 'value', parameters('cosmosContainerName'))))]"
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('identityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[parameters('managedEnvironmentId')]",
                "configuration": {
                  "ingress": {
                    "external": true,
                    "targetPort": "[parameters('targetPort')]",
                    "transport": "auto",
                    "allowInsecure": false
                  },
                  "registries": [
                    {
                      "server": "[parameters('acrLoginServer')]",
                      "identity": "[parameters('identityId')]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "name": "[parameters('name')]",
                      "image": "[parameters('image')]",
                      "resources": {
                        "cpu": "[json(parameters('cpu'))]",
                        "memory": "[parameters('memory')]"
                      },
                      "env": "[variables('mergedEnv')]"
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]",
                    "rules": [
                      {
                        "name": "http-requests",
                        "http": {
                          "metadata": {
                            "concurrentRequests": "10"
                          }
                        }
                      }
                    ]
                  }
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "fqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn]"
            },
            "identityClientId": {
              "type": "string",
              "value": "[parameters('identityClientId')]"
            }
          }
        }
      },
      "dependsOn": [
        "backendIdentity",
        "containerAppEnvironment",
        "containerRegistry",
        "cosmos"
      ]
    },
    "frontendApp": {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "frontend-app",
      "properties": {
        "expressionEvaluationOptions": {
          "scope": "inner"
        },
        "mode": "Incremental",
        "parameters": {
          "location": {
            "value": "[parameters('location')]"
          },
          "name": {
            "value": "[parameters('frontendAppName')]"
          },
          "managedEnvironmentId": {
            "value": "[listOutputsWithSecureValues(resourceId('Microsoft.Resources/deployments', 'container-app-environment'), '2022-09-01').environmentId]"
          },
          "image": {
            "value": "[parameters('frontendContainerImage')]"
          },
          "targetPort": {
            "value": "[parameters('frontendTargetPort')]"
          },
          "minReplicas": {
            "value": "[parameters('frontendMinReplicas')]"
          },
          "maxReplicas": {
            "value": "[parameters('frontendMaxReplicas')]"
          },
          "cpu": {
            "value": "[parameters('frontendCpu')]"
          },
          "memory": {
            "value": "[parameters('frontendMemory')]"
          },
          "backendUrl": {
            "value": "[reference('backendApp').outputs.fqdn.value]"
          },
          "identityId": {
            "value": "[reference('frontendIdentity').outputs.id.value]"
          },
          "acrLoginServer": {
            "value": "[reference('containerRegistry').outputs.loginServer.value]"
          },
          "tags": {
            "value": "[parameters('resourceTags')]"
          }
        },
        "template": {
          "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
          "contentVersion": "1.0.0.0",
          "metadata": {
            "_generator": {
              "name": "bicep",
              "version": "0.35.1.17967",
              "templateHash": "13922994775498909687"
            }
          },
          "parameters": {
            "location": {
              "type": "string",
              "metadata": {
                "description": "Deployment location for the frontend container app."
              }
            },
            "name": {
              "type": "string",
              "metadata": {
                "description": "Name of the container app."
              }
            },
            "managedEnvironmentId": {
              "type": "string",
              "metadata": {
                "description": "Resource ID of the Container Apps managed environment."
              }
            },
            "image": {
              "type": "string",
              "metadata": {
                "description": "Container image to deploy."
              }
            },
            "targetPort": {
              "type": "int",
              "metadata": {
                "description": "Target port exposed by the container."
              }
            },
            "minReplicas": {
              "type": "int",
              "defaultValue": 1,
              "metadata": {
                "description": "Minimum number of replicas."
              }
            },
            "maxReplicas": {
              "type": "int",
              "defaultValue": 2,
              "metadata": {
                "description": "Maximum number of replicas."
              }
            },
            "cpu": {
              "type": "string",
              "defaultValue": "0.5",
              "metadata": {
                "description": "CPU allocation for the container (e.g. \"0.5\")."
              }
            },
            "memory": {
              "type": "string",
              "defaultValue": "1Gi",
              "metadata": {
                "description": "Memory allocation for the container (e.g. \"1Gi\")."
              }
            },
            "backendUrl": {
              "type": "string",
              "metadata": {
                "description": "Backend URL exposed as VITE_BACKEND_URL environment variable."
              }
            },
            "identityId": {
              "type": "string",
              "metadata": {
                "description": "User-assigned identity resource ID."
              }
            },
            "acrLoginServer": {
              "type": "string",
              "metadata": {
                "description": "Login server of the Azure Container Registry used for the image."
              }
            },
            "tags": {
              "type": "object",
              "defaultValue": {},
              "metadata": {
                "description": "Tags to apply to the container app."
              }
            }
          },
          "resources": [
            {
              "type": "Microsoft.App/containerApps",
              "apiVersion": "2024-03-01",
              "name": "[parameters('name')]",
              "location": "[parameters('location')]",
              "tags": "[parameters('tags')]",
              "identity": {
                "type": "UserAssigned",
                "userAssignedIdentities": {
                  "[format('{0}', parameters('identityId'))]": {}
                }
              },
              "properties": {
                "managedEnvironmentId": "[parameters('managedEnvironmentId')]",
                "configuration": {
                  "ingress": {
                    "external": true,
                    "targetPort": "[parameters('targetPort')]",
                    "transport": "auto"
                  },
                  "registries": [
                    {
                      "server": "[parameters('acrLoginServer')]",
                      "identity": "[parameters('identityId')]"
                    }
                  ]
                },
                "template": {
                  "containers": [
                    {
                      "name": "[parameters('name')]",
                      "image": "[parameters('image')]",
                      "resources": {
                        "cpu": "[json(parameters('cpu'))]",
                        "memory": "[parameters('memory')]"
                      },
                      "env": [
                        {
                          "name": "VITE_BACKEND_URL",
                          "value": "[parameters('backendUrl')]"
                        }
                      ]
                    }
                  ],
                  "scale": {
                    "minReplicas": "[parameters('minReplicas')]",
                    "maxReplicas": "[parameters('maxReplicas')]"
                  }
                }
              }
            }
          ],
          "outputs": {
            "id": {
              "type": "string",
              "value": "[resourceId('Microsoft.App/containerApps', parameters('name'))]"
            },
            "name": {
              "type": "string",
              "value": "[parameters('name')]"
            },
            "fqdn": {
              "type": "string",
              "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('name')), '2024-03-01').configuration.ingress.fqdn]"
            }
          }
        }
      },
      "dependsOn": [
        "backendApp",
        "containerAppEnvironment",
        "containerRegistry",
        "frontendIdentity"
      ]
    }
  },
  "outputs": {
    "cosmosEndpoint": {
      "type": "string",
      "value": "[listOutputsWithSecureValues(resourceId('Microsoft.Resources/deployments', 'cosmos-db'), '2022-09-01').endpoint]"
    },
    "cosmosPrimaryKey": {
      "type": "string",
      "value": "[listOutputsWithSecureValues(resourceId('Microsoft.Resources/deployments', 'cosmos-db'), '2022-09-01').primaryKey]"
    },
    "cosmosPrimaryConnectionString": {
      "type": "string",
      "value": "[listOutputsWithSecureValues(resourceId('Microsoft.Resources/deployments', 'cosmos-db'), '2022-09-01').connectionString]"
    },
    "backendFqdn": {
      "type": "string",
      "value": "[reference('backendApp').outputs.fqdn.value]"
    },
    "frontendFqdn": {
      "type": "string",
      "value": "[reference('frontendApp').outputs.fqdn.value]"
    },
    "acrLoginServer": {
      "type": "string",
      "value": "[reference('containerRegistry').outputs.loginServer.value]"
    },
    "backendIdentityClientId": {
      "type": "string",
      "value": "[reference('backendIdentity').outputs.clientId.value]"
    },
    "frontendIdentityClientId": {
      "type": "string",
      "value": "[reference('frontendIdentity').outputs.clientId.value]"
    },
    "githubManagedIdentityClientId": {
      "type": "string",
      "value": "[reference('githubIdentity').outputs.clientId.value]"
    },
    "containerAppsEnvironmentName": {
      "type": "string",
      "value": "[parameters('containerAppsEnvironmentName')]"
    },
    "backendAppName": {
      "type": "string",
      "value": "[parameters('backendAppName')]"
    },
    "acrName": {
      "type": "string",
      "value": "[parameters('acrName')]"
    },
    "cosmosDatabaseName": {
      "type": "string",
      "value": "[listOutputsWithSecureValues(resourceId('Microsoft.Resources/deployments', 'cosmos-db'), '2022-09-01').databaseName]"
    },
    "cosmosContainerName": {
      "type": "string",
      "value": "[listOutputsWithSecureValues(resourceId('Microsoft.Resources/deployments', 'cosmos-db'), '2022-09-01').containerName]"
    }
  }
}